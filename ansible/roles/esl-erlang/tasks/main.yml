#
# This playbook will download packages at localhost, 
# upload the packages to remote hosts and then install them.
#
# So it will perform the following procedure:
#   1.  Create directory to store packages
#   2.  Install wget command to add Erlang repository if not installed
#   3.  Add Erlang Solution repository
#   4.  Download Erlang OTP package and dependencies
#   5.  Upload the packages to remote hosts
#   6.  Install them
#

---

  - name: Prepare directory to store Erlang and depending packages

    local_action:
      module:       file
      path:         "{{ erlang_rpms_dir }}"
      state:        directory



  - name: Install wget command

    become:         yes

    local_action:
      module:       yum
      name:         wget



  - name: Add Erlang Solution repository

    become:         yes

    local_action:
      module:       yum
      name:         "{{ erlang_solutions_rpm }}"
      state:        installed



  - name: Download Erlang package with dependencies

    become:         yes

    local_action:
      module:       yumdownload
      name:         esl-erlang
      downloaddir:  "{{ erlang_rpms_dir }}"



  - name: Upload Erlang and depending packages

    copy:
      src:          "{{ erlang_rpms_dir }}"
      dest:         "{{ erlang_rpms_dir | dirname }}"



  - name: Install Erlang and depending packages

    become:         yes

    yum:
      name:         "{{ item }}"

    with_fileglob:
      - "{{ erlang_rpms_dir }}/*.rpm"
